name: Deploy ots.olhustad.no

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, runner-nginx]
    steps:
      - name: Setup Node
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          echo "$NVM_DIR/versions/node/$(node -v)/bin" >> $GITHUB_PATH

      - name: Set environment variables
        run: |
          echo "URL=ots.olhustad.no" >> $GITHUB_ENV
          echo "APP_NAME=ots.olhustad" >> $GITHUB_ENV
          echo "PORT=3006" >> $GITHUB_ENV

      - name: Deploy
        run: |
          TARGET_DIR="/home/zom/www/${{ env.URL }}"
          CLONE_DIR="/tmp/deploy-${{ env.URL }}-$$/repo"

          mkdir -p "$TARGET_DIR"
          git clone "git@github.com:${{ github.repository }}.git" "$CLONE_DIR"

          rsync -aq --delete \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='logs' \
            --exclude='public/uploads' \
            "$CLONE_DIR/" "$TARGET_DIR/"
          
          rm -rf "$CLONE_DIR"

          cd "$TARGET_DIR"
          npm ci
          pm2 start ecosystem.config.js --update-env
          pm2 save

      - name: Verify
        run: |
          echo "Waiting for app to be ready..."
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:${{ env.PORT }}/health || echo "000")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "✓ Health check passed with HTTP code: 200"
              exit 0
            fi
            
            echo "Health check returned: $HTTP_CODE (retrying in 2s...)"
            sleep 2
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "✗ Health check failed after $MAX_ATTEMPTS attempts"
          echo "Showing recent logs:"
          pm2 logs ${{ env.APP_NAME }} --lines 50 --nostream || true
          exit 1